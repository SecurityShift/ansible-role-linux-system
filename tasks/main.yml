---
# tasks file for linux-system

- name: "Create custom fact directory"
  file:
    path: "/etc/ansible/facts.d"
    state: "directory"
  notify: update aide
  tags:
    - ansible

- name: Set timezone to UTC
  timezone:
    name: Etc/UTC
  notify: update aide
  tags:
    - timezone

- name: Set root password
  user:
    name: root
    system: true
    comment: "Root User"
    uid: 0
    group: root
    password: '{{ root_password_hash }}'
  when: root_password_hash is defined
  notify: update aide
  tags:
    - rootuser

- name: Create admin groups
  group:
    name: '{{ item.name }}'
    system: true
    gid: '{{ item.gid }}'
    state: present
  with_items: '{{ admin_users }}'
  when: admin_users is defined
  notify: update aide
  tags:
    - adminuser

- name: Create admin users
  user:
    name: '{{ item.name }}'
    system: true
    comment: "Admin User"
    uid: '{{ item.uuid }}'
    group: '{{ item.name }}'
    groups: [ wheel ]
    password: '{{ item.password_hash }}'
    #password_lock: no
  with_items: '{{ admin_users }}'
  notify: update aide
  tags:
    - adminuser

- name: Set admin users authorized key
  authorized_key:
    user: '{{ item.name }}'
    state: present
    key: '{{ item.ssh_public_keys | join("\n") }}'
    exclusive: true
  with_items: '{{ admin_users }}'
  notify: update aide
  tags:
    - adminuser
    - ssh

- name: Remove passwordless sudo from centos user
  file:
    path: '{{ item }}'
    state: absent
  with_items:
    - /etc/sudoers.d/centos
    - /etc/sudoers.d/90-cloud-init-users
  tags:
    - adminuser
    - sudo

- name: Configure anacron
  template:
    src: anacrontab.j2
    dest: /etc/anacrontab
    owner: root
    group: root
    mode: 0600
  notify: update aide
  tags:
    - config
    - anacron
    - cron

- name: Add /etc/profile
  template:
    src: profile.j2
    dest: /etc/profile
    owner: root
    group: root
    mode: 0644
  notify: update aide
  tags:
    - shell
    - profile

- name: Use FQDN in shell prompt
  template:
    src: prompt.sh.j2
    dest: /etc/profile.d/prompt.sh
    owner: root
    group: root
    mode: 0644
  notify: update aide
  tags:
    - shell
    - prompt

- name: Add motd, for post authentication
  template:
    src: motd.j2
    dest: /etc/motd
    owner: root
    group: root
    mode: 0644
  notify: update aide
  tags:
    - shell
    - motd

- name: Add issue, for pre authentication
  template:
    src: issue.j2
    dest: /etc/{{ item }}
    owner: root
    group: root
    mode: 0644
  notify: update aide
  with_items:
    - issue
    - issue.net
  tags:
    - issue
    - shell

- name: Install useful packages
  yum:
    name: '{{ useful_packages }} + {{ required_packages }}'
    state: installed
  notify: update aide
  tags:
    - install
